---
title: Выборка
description: ""
---

**Тип метаданных**

 `query`

**Библиотека компонентов**

```
http://n2oapp.net/framework/config/schema/query-5.0
```
**Атрибуты**

| Наименование | Тип                               | Описание                      | Значение по умолчанию |
|--------------|-----------------------------------|-------------------------------|-----------------------|
| object-id    | Ссылка на [объект](../xml/object) | Идентификатор объекта выборки |                       |
| route        | Строка                            | URL выборки                   | Идентификатор выборки |

**Тело**

&lt;list&gt; - [Получение списка записей](#list) <br/>
&lt;unique&gt; - [Получение уникальной записи](#unique) <br/>
&lt;count&gt; - [Получение количества записей](#count) <br/>
&lt;fields&gt; - [Список полей выборки](#fields) <br/>
&lt;filters&gt; - [Список фильтров выборки](#filters)

**Пример**

```xml
<?xml version='1.0' encoding='UTF-8'?>
<query xmlns="http://n2oapp.net/framework/config/schema/query-5.0"
       object-id="myObject">
    <list>
        <sql>
            SELECT :select FROM mytable
            WHERE :filters
            ORDER BY :sorting
            LIMIT :limit OFFSET :offset
        </sql>
    </list>

    <count>
        <sql>
            SELECT count(*) FROM mytable
            WHERE :filters
        </sql>
    </count>

    <fields>
        ...
    </fields>
</query>
```



## &lt;list&gt; {#list}

Получение списка записей

:::note
В выборке может быть несколько `<list>` с разными наборами фильтров (атрибут `filters`).
:::

**Атрибуты**

| Наименование       | Тип                                  | Описание                                                                                                              | Значение по умолчанию |
|--------------------|--------------------------------------|-----------------------------------------------------------------------------------------------------------------------|-----------------------|
| filters            | Список ссылок на [фильтры](#filters) | Идентификаторы фильтров (через запятую). Вызов провайдера данных сработает только при наличии всех фильтров в запросе |                       |
| result-mapping     | Строка                               | Маппинг списка результатов. Используется SpEL выражение                                                               |                       |
| result-normalize   | Строка                               | Нормализация списка результатов. Используется SpEL выражение                                                          |                       |
| count-mapping      | Строка                               | Маппинг общего количества записей. Используется SpEL выражение                                                        |                       |
| asc-expression     | Строка                               | Выражение ASC направления сортировки                                                                                  | asc                   |
| desc-expression    | Строка                               | Выражение DESC направления сортировки                                                                                 | desc                  |
| additional-mapping | Строка                               | Маппинг дополнительной информации. Используется SpEL выражение                                                        |                       |

**Настройки**

```yaml
#Значение asc направления сортировки
n2o.engine.query.asc-expression = asc
#Значение desc направления сортировки
n2o.engine.query.desc-expression = desc
```

**Тело**

[Провайдер данных](../xml/dataprovider)

**Пример**

```xml
<list filters="firstNameLike, lastNameLike">
    <sql>
        SELECT first_name, last_name
        FROM mytable
        WHERE first_name like '%'||:first_name
        OR last_name '%'||:last_name
    </sql>
</list>
```



## &lt;unique&gt; {#unique}

Получение уникальной записи

:::note
В выборке может быть несколько `<unique>` с разными наборами фильтров (атрибут `filters`).
:::

**Атрибуты**

| Наименование     | Тип                                  | Описание                                                                                                              |
|------------------|--------------------------------------|-----------------------------------------------------------------------------------------------------------------------|
| filters          | Список ссылок на [фильтры](#filters) | Идентификаторы фильтров (через запятую). Вызов провайдера данных сработает только при наличии всех фильтров в запросе |
| result-mapping   | Строка                               | Маппинг результата. Используется SpEL выражение                                                                       |
| result-normalize | Строка                               | Нормализация результата. Используется SpEL выражение                                                                  |

**Тело**

[Провайдер данных](../xml/dataprovider)

**Пример**

```xml
<unique filters="id">
    <sql>
        SELECT first_name, last_name
        FROM mytable
        WHERE id = :id
    </sql>
</unique>
```



## &lt;count&gt; {#count}

Получение количества записей

:::note
В выборке может быть несколько `<count>` с разными наборами фильтров (атрибут `filters`).
:::

**Атрибуты**


| Наименование  | Тип                                  | Описание                                                                                                              |
|---------------|--------------------------------------|-----------------------------------------------------------------------------------------------------------------------|
| filters       | Список ссылок на [фильтры](#filters) | Идентификаторы фильтров (через запятую). Вызов провайдера данных сработает только при наличии всех фильтров в запросе |
| count-mapping | Строка                               | Маппинг количества записей. Используется SpEL выражение                                                               |

**Тело**

[Провайдер данных](../xml/dataprovider)

**Пример**

```xml
<count filters="firstNameLike">
    <sql>
        SELECT count(*) FROM mytable
    </sql>
</count>
```



## &lt;fields&gt; {#fields}

Поля выборки

**Тело**

&lt;field&gt; - [Простое поле](#field) <br/>
&lt;reference&gt; - [Составное поле](#reference) <br/>
&lt;list&gt; - [Списковое поле](#list-field)



### &lt;field&gt; {#field}

Простое поле выборки

**Атрибуты**

| Наименование       | Тип                                         | Описание                                                                              | Значение по умолчанию                             | Обязательность |
|--------------------|---------------------------------------------|---------------------------------------------------------------------------------------|---------------------------------------------------|----------------|
| id                 | Строка                                      | Идентификатор поля                                                                    |                                                   | !              |
| name               | Строка                                      | Наименование поля                                                                     |                                                   |                |
| domain             | [Тип данных](../xml/base#Data_types_domain) | Тип данных                                                                            |                                                   |                |
| default-value      | Строка                                      | Значение по умолчанию. Будет использовано, если значение для поля не передано         |                                                   |                |
| sorting            | true false                                  | Является ли поле сортируемым                                                          | false. Если задан `sorting-expression`, то - true |                |
| sorting-mapping    | Строка                                      | Маппинг плейсхолдера направления сортировки в провайдере. Используется SpEL выражение | [идентификатор_поля]Direction                     |                |
| sorting-expression | Строка                                      | Выражение сортировки поля                                                             |                                                   |                |
| mapping            | Строка                                      | Маппинг данных поля из провайдера. Используется SpEL выражение                        | [' + `id` + ']                                    |                |
| normalize          | Строка                                      | Нормализация данных поля из провайдера. Используется SpEL выражение                   |                                                   |                |
| select             | true false                                  | Участвует ли поле в выборке                                                           | true                                              |                |
| select-expression  | Строка                                      | Выражение для подстановки на место плейсхолдера select в провайдере                   |                                                   |                |

**Настройки**

```yaml
#Участвует ли поле в выборке (для всех видов полей)
n2o.api.query.field.is_selected = true
#Участвует ли поле в сортировке (для всех видов полей)
n2o.api.query.field.is_sorted = false
```

**Тело**

&lt;switch&gt; - [Конструкция switch](#switch) <br/>

**Пример**

```xml
<field id="myName" mapping="['name']" default-value="user" normalize="#this.toUpperCase()">
    <switch>...</switch>
</field>
```



#### &lt;switch&gt; {#switch}

Конструкция switch

**Тело**

&lt;case&gt; - [Вариант переключения](#switch_case) <br/>
&lt;default&gt; - [Вариант по умолчанию](#switch_default)

**Пример**

```xml
<switch>
    <case value="1">Мужской</case>
    <case value="2">Женский</case>
    <default>Неопределенный</default>
</switch>
```



##### &lt;case&gt; {#switch_case}

Вариант переключения

**Атрибуты**

| Наименование | Тип    | Описание                                       | Обязательность |
|--------------|--------|------------------------------------------------|----------------|
| value        | Строка | Значение, с которым сравнивается значение поля | !              |

**Тело**

Значение, возвращаемое в случае совпадения value со значением поля



##### &lt;default&gt; {#switch_default}

Вариант по умолчанию

**Тело**

Значение, которое будет выбрано при несовпадении ни одного из value со значением поля



### &lt;reference&gt; {#reference}

Составное поле выборки

**Атрибуты**

| Наименование      | Тип        | Описание                                                            | Значение по умолчанию | Обязательность |
|-------------------|------------|---------------------------------------------------------------------|-----------------------|----------------|
| id                | Строка     | Идентификатор поля                                                  |                       | !              |
| mapping           | Строка     | Маппинг данных поля из провайдера. Используется SpEL выражение      | [' + `id` + ']        |                |
| normalize         | Строка     | Нормализация данных поля из провайдера. Используется SpEL выражение |                       |                |
| select            | true false | Участвует ли поле в выборке                                         | true                  |                |
| select-expression | Строка     | Выражение для подстановки на место плейсхолдера select в провайдере |                       |                |
| select-key        | Строка     | Ключ для подстановки на место плейсхолдера в select-expression      |                       |                |

**Тело**

&lt;field&gt; - [Простое поле](#field) <br/>
&lt;reference&gt; - [Составное поле](#reference) <br/>
&lt;list&gt; - [Списковое поле](#list-field)

**Пример**

```xml
<reference id="owner" select-expression="owner { $$ownerSelect }" select-key="ownerSelect">
    <field>...</field>
    <list>...</list>
    <reference>...</reference>
</reference>
```



### &lt;list&gt; {#list-field}

Списковое поле выборки

**Атрибуты**

| Наименование      | Тип        | Описание                                                            |Значение по умолчанию | Обязательность |
|-------------------|------------|---------------------------------------------------------------------|----------------------|----------------|
| id                | Строка     | Идентификатор поля                                                  |                      | !              |
| mapping           | Строка     | Маппинг данных поля из провайдера. Используется SpEL выражение      | [' + `id` + ']       |                |
| normalize         | Строка     | Нормализация данных поля из провайдера. Используется SpEL выражение |                      |                |
| select            | true false | Участвует ли поле в выборке                                         | true                 |                |
| select-expression | Строка     | Выражение для подстановки на место плейсхолдера select в провайдере |                      |                |
| select-key        | Строка     | Ключ для подстановки на место плейсхолдера в select-expression      |                      |                |

**Тело**

&lt;field&gt; - [Простое поле](#field) <br/>
&lt;reference&gt; - [Составное поле](#reference) <br/>
&lt;list&gt; - [Списковое поле](#list-field)

**Пример**

```xml
<list id="showrooms" select-key="showroomsSelect"
      select-expression="showrooms { $$showroomsSelect }">
    <field>...</field>
    <list>...</list>
    <reference>...</reference>
</list>
```



## &lt;filters&gt; {#filters}

Список фильтров выборки

**Тело**

| Наименование       | Тип       | Описание                                 |
|--------------------|---------- |------------------------------------------|
| &lt;eq&gt;         | Выражение | Фильтр эквивалентности                   |
| &lt;notEq&gt;      | Выражение | Фильтр не эквивалентности                |
| &lt;more&gt;       | Выражение | Фильтр больше                            |
| &lt;less&gt;       | Выражение | Фильтр меньше                            |
| &lt;like&gt;       | Выражение | Фильтр вхождения подстроки в строку      |
| &lt;in&gt;         | Выражение | Фильтр вхождения хотя бы одного в список |
| &lt;notIn&gt;      | Выражение | Фильтр не вхождения в список             |
| &lt;contains&gt;   | Выражение | Фильтр вхождения списка в список         |
| &lt;isNull&gt;     | Выражение | Фильтр пустого поля                      |
| &lt;isNotNull&gt;  | Выражение | Фильтр не пустого поля                   |
| &lt;eqOrIsNull&gt; | Выражение | Фильтр эквивалентности и не пустого поля |
| &lt;likeStart&gt;  | Выражение | Фильтр начала подстроки                  |

:::note
Важно отметить, что тип фильтра играет роль только для `<test>` и `<mongo>` провайдеров.
В таком случае тело фильтра может быть сгенерировано согласно его типу.
Во всех остальных ситуациях указание тела фильтра обязательно,
а его тип служит скорее удобным указанием для какой фильтрации он используется,
но не несет никакой дополнительной функции.
:::

**Значения выражений по умолчанию для разных провайдеров**

| Наименование       | test                          | mongo                                     |
|--------------------|-------------------------------|-------------------------------------------|
| &lt;eq&gt;         | fieldId :eq :filterId         | \{'fieldId' : filterId}                   |
| &lt;notEq&gt;      | fieldId :notEq :filterId      | \{'fieldId': \{$ne: '#filterId'}}         |
| &lt;more&gt;       | fieldId :more :filterId       | \{'fieldId': \{$gte: '#filterId'}}        |
| &lt;less&gt;       | fieldId :less :filterId       | \{'fieldId': \{$lte: '#filterId'}}        |
| &lt;like&gt;       | fieldId :like :filterId       | \{'fieldId': \{$regex: '.\*#filterId.*'}} |
| &lt;in&gt;         | fieldId :in :filterId         | \{'fieldId': \{$in: '#filterId'}}         |
| &lt;notIn&gt;      | fieldId :notIn :filterId      | \{'fieldId': \{$nin: '#filterId'}}        |
| &lt;contains&gt;   | fieldId :contains :filterId   | -                                         |
| &lt;isNull&gt;     | fieldId :isNull :filterId     | -                                         |
| &lt;isNotNull&gt;  | fieldId :isNotNull :filterId  | -                                         |
| &lt;eqOrIsNull&gt; | fieldId :eqOrIsNull :filterId | -                                         |
| &lt;likeStart&gt;  | -                             | \{'fieldId': \{$regex: '#filterId.*'}}    |

**Базовые атрибуты**

| Наименование  | Тип                                         | Описание                                                                               | Значение по умолчанию          | Обязательность |
|---------------|---------------------------------------------|----------------------------------------------------------------------------------------|--------------------------------|----------------|
| filter-id     | Строка                                      | Идентификатор фильтра                                                                  |                                |                |
| field-id      | Ссылка на [поле](#field)                    | Идентификатор поля фильтра                                                             |                                |                |
| mapping       | Строка                                      | Маппинг значения фильтра в поле провайдера. Используется SpEL выражение                | [' + `filter-id` + ']          | !              |
| domain        | [Тип данных](../xml/base#Data_types_domain) | Тип данных, к которому будет приведено значение фильтра                                | Значение `domain` от `<field>` |                |
| default-value | Строка                                      | Значение, которое будет использоваться, если значение фильтра не передано              |                                |                |
| normalize     | Строка                                      | Выражение для предварительной нормализации данных фильтра. Используется SpEL выражение |                                |                |
| required      | true false                                  | Обязательность фильтра выборки                                                         | false                          |                |

**Пример**

```xml
<filters>
    <eq field-id="gender.id" mapping="gender_id" default-value="1">
        gender_id = :gender_id
    </eq>
    <in field-id="genders" filter-id="genders*.id" domain="integer[]">
        gender_id in (:genders)
    </in>
    <like field-id="gender.name" filter-id="gender.name"
          domain="string" normalize="#this.toLowerCase()"/>
</filters>
```
